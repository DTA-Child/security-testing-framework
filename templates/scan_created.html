{% extends "base.html" %}

{% block title %}Scan Started - Security Testing Framework{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Success Message -->
        <div class="alert alert-success" role="alert">
            <h4 class="alert-heading">
                <i class="bi bi-check-circle"></i>
                Scan Started Successfully!
            </h4>
            <p>Your security scan has been initiated and is now running.</p>
        </div>

        <!-- Scan Details -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    Scan Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Scan ID:</strong><br>
                        <code class="fs-6">{{ scan_id }}</code>
                    </div>
                    <div class="col-md-6">
                        <strong>Target URL:</strong><br>
                        <a href="{{ target_url }}" target="_blank" class="text-decoration-none">
                            {{ target_url }}
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <strong>Selected Scanners:</strong>
                    <div class="mt-2">
                        {% for scanner in scan_types %}
                        <span class="badge bg-primary me-1">
                            {% if scanner == 'zap' %}
                            <i class="bi bi-shield-check"></i> ZAP
                            {% elif scanner == 'nuclei' %}
                            <i class="bi bi-bug"></i> Nuclei
                            {% elif scanner == 'nikto' %}
                            <i class="bi bi-search"></i> Nikto
                            {% endif %}
                        </span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Progress Section -->
                <div class="mb-3">
                    <strong>Progress:</strong>
                    <div class="progress mt-2" id="progressContainer">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" id="progressBar">
                            <span id="progressText">Initializing...</span>
                        </div>
                    </div>
                </div>

                <!-- Status Updates -->
                <div id="statusUpdates" class="mt-3">
                    <div class="alert alert-info">
                        <i class="bi bi-hourglass-split"></i>
                        Scan is starting, please wait...
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <a href="/scan/{{ scan_id }}" class="btn btn-primary" id="viewDetailsBtn">
                        <i class="bi bi-eye"></i>
                        View Details
                    </a>
                    <a href="/scans" class="btn btn-outline-secondary">
                        <i class="bi bi-list-ul"></i>
                        All Scans
                    </a>
                    <a href="/" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle"></i>
                        New Scan
                    </a>
                </div>
            </div>
        </div>

        <!-- Expected Timeline -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="bi bi-clock"></i>
                    Expected Timeline
                </h6>
                <ul class="list-unstyled mb-0">
                    <li><i class="bi bi-check text-success"></i> Scan initialization: <strong>Completed</strong></li>
                    <li><i class="bi bi-hourglass-split text-warning"></i> Scanner execution: <strong>1-3 minutes</strong></li>
                    <li><i class="bi bi-clock text-muted"></i> Results processing: <strong>Few seconds</strong></li>
                    <li><i class="bi bi-clock text-muted"></i> Report generation: <strong>Ready when complete</strong></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const scanId = '{{ scan_id }}';
let pollInterval;

function updateScanStatus() {
    fetch(`/api/scan/${scanId}`)
        .then(response => response.json())
        .then(data => {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusUpdates = document.getElementById('statusUpdates');
            
            // Update progress bar
            const progress = data.progress || 0;
            progressBar.style.width = progress + '%';
            progressText.textContent = `${progress}%`;
            
            // Update status
            let statusClass = 'alert-info';
            let statusIcon = 'bi-hourglass-split';
            let statusMessage = 'Scan is running...';
            
            if (data.status === 'completed') {
                statusClass = 'alert-success';
                statusIcon = 'bi-check-circle';
                statusMessage = 'Scan completed successfully!';
                progressBar.classList.remove('progress-bar-animated');
                clearInterval(pollInterval);
                
                // Show results summary
                if (data.results) {
                    let totalVulns = 0;
                    Object.values(data.results).forEach(result => {
                        if (result.summary) {
                            totalVulns += result.summary.total || 0;
                        }
                    });
                    statusMessage += ` Found ${totalVulns} security findings.`;
                }
                
            } else if (data.status === 'failed') {
                statusClass = 'alert-danger';
                statusIcon = 'bi-exclamation-triangle';
                statusMessage = 'Scan failed. Please try again.';
                progressBar.classList.remove('progress-bar-animated');
                clearInterval(pollInterval);
            }
            
            statusUpdates.innerHTML = `
                <div class="alert ${statusClass}">
                    <i class="bi ${statusIcon}"></i>
                    ${statusMessage}
                </div>
            `;
            
        })
        .catch(error => {
            console.error('Error fetching scan status:', error);
        });
}

// Start polling for status updates
pollInterval = setInterval(updateScanStatus, 2000);

// Initial status check
updateScanStatus();

// Auto-redirect to details when complete (optional)
setTimeout(() => {
    fetch(`/api/scan/${scanId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'completed') {
                // Uncomment to auto-redirect
                // window.location.href = `/scan/${scanId}`;
            }
        });
}, 30000); // Check after 30 seconds
</script>
{% endblock %}